pop40 <- data.frame(
  year = rep(1940:1949,e=9),
  agebin = rep(c("10-14","15-19","20-24","25-29",
                 "30-34","35-39","40-44","45-49",
                 "remainder"), 10),
  thous = c(5777,6145,5907,5665,5192,4823,4387,4057,90169,
            5699,6107,5943,5731,5270,4908,4463,4119,91162,
            5608,6059,5972,5788,5340,4986,4536,4185,92386,
            5507,6000,5990,5839,5407,5061,4609,4252,94074,
            5395,5930,5999,5887,5472,5137,4681,4318,95578,
            5294,5844,5995,5938,5539,5218,5746,4382,96962,
            5260,5735,5999,6004,5609,5306,4831,4432,96213,
            5252,5616,5985,6080,5683,5410,4908,4468,100724,
            5308,5497,5957,6157,5761,5524,4969,4497,102941,
            5388,5381,5917,6227,5838,5641,5073,4528,105194
  )
)


pop50 <- data.frame(
  year = rep(1950:1959,e=9),
  agebin = rep(c("10-14","15-19","20-24","25-29",
                 "30-34","35-39","40-44","45-49",
                 "remainder"), 10),
  thous = c(5506,5294,5886,6291,5942,5762,5169,4576,107845,
            5650,5240,5800,6248,6053,5819,5260,4670,110138,
            5872,5235,5692,6187,6167,5873,5353,4790,112384,
            6218,5307,5547,6148,6221,5919,5443,4902,114479,
            6475,5410,5425,6064,6294,5961,5522,5019,116856,
            6694,5482,5363,5977,6337,6023,5596,5131,119328,
            6833,5628,5317,5907,6309,6132,5672,5220,121885,
            7387,5843,5312,5812,6257,6243,5744,5309,124077,
            7636,6186,5384,5679,6231,6296,5810,5397,126263,
            7971,6436,5483,5563,6155,6365,5871,5473,128513
  )
)


pop60 <- data.frame(
  year = rep(1960:1969,e=9),
  agebin = rep(c("10-14","15-19","20-24","25-29",
                 "30-34","35-39","40-44","45-49",
                 "remainder"), 10),
  thous = c(8323,6639,5564,5512,6076,6402,5946,5535,129980,
            8771,6794,5737,5476,5985,6400,6043,5585,132201,
            8749,7376,5973,5468,5876,6362,6152,5831,134184,
            8911,7647,6345,5533,5767,6297,6256,5683,136044,
            9114,8008,6618,5637,5658,6212,6322,5747,137815,
            9357,8386,6846,5727,5607,6121,6368,5827,139287,
            9565,8842,6993,5889,5579,6030,6373,5925,140380,
            9800,8836,7581,6105,5585,5933,6347,6038,141232,
            9990,9013,7847,6455,5659,5829,6294,6148,142164,
            10128,9234,8187,6696,5768,5725,6222,6230,143195
  )
)

pop70 <- data.frame(
  year = rep(1970:1979,e=9),
  agebin = rep(c("10-14","15-19","20-24","25-29",
                 "30-34","35-39","40-44","45-49",
                 "remainder"), 10),
  thous = c(10230,9517,8544,6914,5871,5679,6148,6277,144804,
            10346,9740,9027,7061,6036,5665,6062,6280,146610,
            10347,9988,9021,7652,6268,5688,5971,6223,148126,
            10310,10193,9198,7918,6652,5744,5885,6178,149279,
            10243,10349,9415,8282,6929,5836,5797,6114,150377,
            10112,10465,9677,8660,7173,5931,5700,6072,151675,
            9837,10582,9901,9157,7317,6075,5689,5994,153011,
            9550,10581,10152,9157,7928,6283,5713,5910,154486,
            9262,10555,10373,9357,8205,6651,5780,5838,156074,
            9031,10498,10541,9597,8579,6918,5883,5766,157754
  )
)


pop80 <- data.frame(
  year = rep(1980:1990,e=9),
  agebin = rep(c("10-14","15-19","20-24","25-29",
                 "30-34","35-39","40-44","45-49",
                 "remainder"), 11),
  thous = c(8923,10377,10680,9896,8974,7159,5988,5677,159581,
            8953,10080,10790,10132,9481,7310,6136,5643,161112,
            8877,9779,10781,10396,9482,7918,6354,5656,162753,
            8747,9471,10729,10607,9672,8201,6699,5754,164404,
            8544,9231,10642,10753,9900,8584,6942,5872,165997,
            8339,9106,10482,10869,10172,8967,7167,5968,167666,
            8078,9126,10183,10982,10407,9467,7316,6110,169436,
            8035,9047,9877,10971,10674,9466,7929,6325,171103,
            8102,8923,9576,10924,10895,9660,8210,6668,172847,
            8260,8721,9335,10837,11059,9890,8589,6920,174648,
            8447,8525,9223,10691,11175,10167,8987,7150,176648)
)

pop_str_data <- bind_rows(pop40,pop50,pop60,pop70,pop80)

birthdata <-
  read_csv("C:/Users/jking34/Downloads/NCHS_-_Birth_Rates_for_Females_by_Age_Group__United_States.csv") |>
  mutate(
    agebin=gsub(" Years","",`Age Group`),
    birthrate=`Birth Rate`,
    year=Year
  ) |> filter(year < 1980) |> select(year,agebin,birthrate)

birthrate_add <- tibble(
  year = rep(1980:1990,e=9),
  agebin = rep(c("10-14","15-19","20-24","25-29",
                 "30-34","35-39","40-44","45-49",
                 "remainder"), 11),
  birthrate = c(1.1,53.0,115.1,112.9,61.9,19.8,3.9,.2,0,
                1.1,52.7,111.8,112.0,61.4,20.0,3.8,.2,0,
                1.1,52.9,111.3,111.0,64.2,21.1,3.9,.2,0,
                1.1,51.7,108.3,108.7,64.6,22.1,3.8,.2,0,
                1.2,50.9,107.3,108.3,66.5,22.8,3.9,.2,0,
                1.2,51.3,108.9,110.5,68.5,23.9,4.0,.2,0,
                1.3,50.6,108.2,109.2,69.3,24.3,4.1,.2,0,
                1.3,51.1,108.9,110.8,71.3,26.2,4.4,.2,0,
                1.3,53.6,111.5,113.4,72.7,27.9,4.8,.2,0,
                1.4,58.1,115.4,116.6,76.2,29.7,5.2,.2,0,
                1.5,60.7,120.6,121.8,79.6,31.0,5.4,.2,0)
)

birthdata <- bind_rows(birthdata, birthrate_add)


## combined
# left_join(pop_str_data, birthdata) %>%
#   mutate(
#     birthrate=ifelse(agebin=="remainder",0,birthrate)
#   ) |>
#   write_csv(file="archive/uspop_dg.csv")

ratedata <-
  left_join(pop_str_data, birthdata) %>%
  mutate(
    birthrate=ifelse(agebin=="remainder",0,birthrate)
  ) |>
  group_by(year) |>
  mutate(
    totalpop = sum(thous),
    pop_str=thous/totalpop
  ) |> ungroup()

ratedata <- read_csv("archive/uspop_dg.csv") |>
  group_by(year) |>
  mutate(
    totalpop = sum(thous),
    pop_str=thous/totalpop
  ) |> ungroup()


rates_crude <-
  ratedata %>%
  mutate(rate=birthrate*pop_str) %>%
  group_by(year) %>%
  summarise(rate=sum(rate),
            factor="crude")

ggplot(rates_crude, aes(x=year,y=rate))+geom_path()


dres.all <-
  dgnpop(
    ratedata,
    pop="year",
    factors=c("birthrate","pop_str"),
    ratefunction="sum(birthrate*pop_str)",
    id_vars=c("agebin"),
    quietly=FALSE
  )

dgr = dg_rates(dres.all)


bind_rows(
  rates_crude |> mutate(type="crude",year=as.character(year)),
  dgr |> filter(factor=="birthrate") |>
    transmute(year = pop, rate=adj.rate,type=".all")
) |> mutate(year=as.numeric(year)) |>
  arrange(year,type) |>
  #select(-factor) |> pivot_wider(names_from=type,values_from=rate) |> view()
  ggplot(aes(x=year,y=rate,col=type,lty=type))+
  geom_line(size=1) + theme_bw()+
  scale_y_continuous(limits=c(13,33),breaks=c(13,18,23,28,33))





